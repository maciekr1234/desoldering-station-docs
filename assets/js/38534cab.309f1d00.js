"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[4504],{28453:(e,t,n)=>{n.d(t,{R:()=>d,x:()=>a});var s=n(96540);const i={},r=s.createContext(i);function d(e){const t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(r.Provider,{value:t},e.children)}},70103:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"core/settings","title":"Settings System","description":"Persistent configuration storage using LittleFS.","source":"@site/docs/core/settings.md","sourceDirName":"core","slug":"/core/settings","permalink":"/desoldering-station-docs/docs/core/settings","draft":false,"unlisted":false,"editUrl":"https://github.com/maciekr1234/desoldering-station/tree/master/docs-site/docs/core/settings.md","tags":[],"version":"current","lastUpdatedAt":1766797362000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Core","permalink":"/desoldering-station-docs/docs/category/core"},"next":{"title":"Logging System","permalink":"/desoldering-station-docs/docs/core/logging"}}');var i=n(74848),r=n(28453);const d={sidebar_position:1},a="Settings System",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Settings Structure",id:"settings-structure",level:2},{value:"API Reference",id:"api-reference",level:2},{value:"Initialization",id:"initialization",level:3},{value:"Load/Save/Reset",id:"loadsavereset",level:3},{value:"Generic Load/Save",id:"generic-loadsave",level:3},{value:"Debug Output",id:"debug-output",level:3},{value:"Default Values",id:"default-values",level:2},{value:"JSON Format",id:"json-format",level:2},{value:"Example Usage",id:"example-usage",level:2},{value:"Startup Initialization",id:"startup-initialization",level:3},{value:"Reading Settings",id:"reading-settings",level:3},{value:"Modifying Settings",id:"modifying-settings",level:3},{value:"Adding New Settings",id:"adding-new-settings",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Source Files",id:"source-files",level:2}];function o(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"settings-system",children:"Settings System"})}),"\n",(0,i.jsx)(t.p,{children:"Persistent configuration storage using LittleFS."}),"\n",(0,i.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(t.p,{children:["The Settings system provides a centralized configuration store (",(0,i.jsx)(t.code,{children:"gSettings"}),") with JSON persistence to flash storage using LittleFS and ArduinoJson."]}),"\n",(0,i.jsx)(t.h2,{id:"features",children:"Features"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Global settings structure with defaults"}),"\n",(0,i.jsx)(t.li,{children:"JSON serialization/deserialization"}),"\n",(0,i.jsx)(t.li,{children:"LittleFS persistence"}),"\n",(0,i.jsx)(t.li,{children:"Versioned settings format"}),"\n",(0,i.jsx)(t.li,{children:"Reset to defaults support"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsx)(t.mermaid,{value:"graph TB\n    subgraph Runtime\n        gSettings[gSettings<br/>Global Structure]\n        defaults[default_settings<br/>Compile-time Defaults]\n    end\n    \n    subgraph Storage\n        JSON[settings.json]\n        LittleFS[LittleFS<br/>Flash Partition]\n    end\n    \n    subgraph Access\n        Heater[HeaterController]\n        Pump[PumpController]\n        UI[LVGL UI]\n    end\n    \n    Access --\x3e|Read/Write| gSettings\n    gSettings <--\x3e|Load/Save| JSON\n    JSON --\x3e|Stored in| LittleFS\n    defaults --\x3e|Reset| gSettings"}),"\n",(0,i.jsx)(t.h2,{id:"settings-structure",children:"Settings Structure"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",metastring:'title="include/core/settings.h"',children:"#define SETTINGS_VERSION 2\n\ntypedef enum {\n    HEATER_STARTUP_SLEEP   = 0, // Heater stays in sleep mode at startup\n    HEATER_STARTUP_STANDBY = 1, // Heater enters standby at startup\n    HEATER_STARTUP_ON      = 2, // Heater starts heating immediately\n} heater_startup_state_t;\n\ntypedef struct {\n    uint32_t frequency_hz;     // Pump PWM frequency in Hz\n    uint32_t acceleration_ms;  // Pump acceleration time in ms\n} pump_settings_t;\n\ntypedef struct {\n    uint16_t max_temperature;      // Maximum allowable temperature\n    uint16_t min_temperature;      // Minimum allowable temperature\n    uint16_t default_temperature;  // Default target temperature\n    uint16_t standby_temperature;  // Standby temperature\n    uint32_t heating_timeout_ms;   // Timeout to reach target (ms)\n    uint32_t standby_timeout_ms;   // Inactivity timeout before standby (ms)\n    uint32_t sleep_timeout_ms;     // Inactivity timeout before sleep (ms)\n    uint8_t  startup_state;        // Heater state at startup (heater_startup_state_t)\n    \n    pid_tunings_t pid;  // PID controller parameters\n    \n    struct {  // Temperature calibration\n        uint16_t at100, at200, at300, at350, at400, at450;\n    } calibration;\n} heater_settings_t;\n\ntypedef struct {\n    bool    encoder_inverted;    // Invert encoder direction\n    uint8_t display_brightness;  // Normal brightness (0-100)\n    uint8_t standby_brightness;  // Standby brightness (0-100)\n    uint8_t sleep_brightness;    // Sleep brightness (0-100)\n} system_settings_t;\n\ntypedef struct _settings_t {\n    uint8_t           version;  // Settings format version\n    heater_settings_t heater;   // Heater-related settings\n    pump_settings_t   pump;     // Pump motor settings\n    system_settings_t system;   // System/UI settings\n} settings_t;\n\nextern settings_t gSettings;\nextern const settings_t default_settings;\n"})}),"\n",(0,i.jsx)(t.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,i.jsx)(t.h3,{id:"initialization",children:"Initialization"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:'#include "settings.h"\n\n// Initialize settings system\nvoid init_settings();\n\n// Check if settings have been loaded\nbool global_settings_loaded();\n'})}),"\n",(0,i.jsx)(t.h3,{id:"loadsavereset",children:"Load/Save/Reset"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"// Load from LittleFS (falls back to defaults if missing)\nbool load_global_settings();\n\n// Save to LittleFS\nbool save_global_settings();\n\n// Reset to compile-time defaults\nbool reset_global_settings();\n"})}),"\n",(0,i.jsx)(t.h3,{id:"generic-loadsave",children:"Generic Load/Save"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"// Load from custom file\nbool load_settings(settings_t* settings, const char* filename);\n\n// Save to custom file\nbool save_settings(const settings_t* settings, const char* filename);\n"})}),"\n",(0,i.jsx)(t.h3,{id:"debug-output",children:"Debug Output"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"// Print settings to Serial or other Print interface\nsize_t printSettings(Print& print, const settings_t& settings);\n"})}),"\n",(0,i.jsx)(t.h2,{id:"default-values",children:"Default Values"}),"\n",(0,i.jsxs)(t.p,{children:["Key default values from ",(0,i.jsx)(t.code,{children:"default_settings"}),":"]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Setting"}),(0,i.jsx)(t.th,{children:"Default Value"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.max_temperature"})}),(0,i.jsx)(t.td,{children:"450\xb0C"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.min_temperature"})}),(0,i.jsx)(t.td,{children:"100\xb0C"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.default_temperature"})}),(0,i.jsx)(t.td,{children:"300\xb0C"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.standby_temperature"})}),(0,i.jsx)(t.td,{children:"180\xb0C"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.heating_timeout_ms"})}),(0,i.jsx)(t.td,{children:"300000 (5 min)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.standby_timeout_ms"})}),(0,i.jsx)(t.td,{children:"600000 (10 min)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.sleep_timeout_ms"})}),(0,i.jsx)(t.td,{children:"900000 (15 min)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.startup_state"})}),(0,i.jsx)(t.td,{children:"HEATER_STARTUP_SLEEP"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.pid.kp"})}),(0,i.jsx)(t.td,{children:"1.0"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.pid.ki"})}),(0,i.jsx)(t.td,{children:"0.8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"heater.pid.kd"})}),(0,i.jsx)(t.td,{children:"3.5"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"pump.frequency_hz"})}),(0,i.jsx)(t.td,{children:"20000"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"pump.acceleration_ms"})}),(0,i.jsx)(t.td,{children:"1000"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"system.display_brightness"})}),(0,i.jsx)(t.td,{children:"100"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"system.standby_brightness"})}),(0,i.jsx)(t.td,{children:"90"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"system.sleep_brightness"})}),(0,i.jsx)(t.td,{children:"50"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"json-format",children:"JSON Format"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",metastring:'title="data/settings.json"',children:'{\n  "version": 2,\n  "heater": {\n    "max_temperature": 450,\n    "min_temperature": 100,\n    "default_temperature": 300,\n    "standby_temperature": 180,\n    "heating_timeout_ms": 300000,\n    "standby_timeout_ms": 600000,\n    "sleep_timeout_ms": 900000,\n    "startup_state": 0,\n    "pid": {\n      "kp": 1.0,\n      "ki": 0.8,\n      "kd": 3.5,\n      "imax": 50.0,\n      "imin": -5.0\n    },\n    "calibration": {\n      "at100": 100, "at200": 200, "at300": 300,\n      "at350": 350, "at400": 400, "at450": 450\n    }\n  },\n  "pump": {\n    "frequency_hz": 20000,\n    "acceleration_ms": 1000\n  },\n  "system": {\n    "encoder_inverted": false,\n    "display_brightness": 100,\n    "standby_brightness": 90,\n    "sleep_brightness": 50\n  }\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"example-usage",children:"Example Usage"}),"\n",(0,i.jsx)(t.h3,{id:"startup-initialization",children:"Startup Initialization"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:'void setup() {\n    // Initialize settings system\n    init_settings();\n    \n    // Load from flash (uses defaults if not found)\n    if (!load_global_settings()) {\n        PICO_LOGW("SETTINGS", "Using defaults, saving...");\n        save_global_settings();\n    }\n    \n    // Apply loaded settings\n    heater.setTargetTemperature(gSettings.heater.default_temperature);\n}\n'})}),"\n",(0,i.jsx)(t.h3,{id:"reading-settings",children:"Reading Settings"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"void apply_pid_settings() {\n    pid_ctrl_parameter_t params = {\n        .kp = gSettings.heater.pid.kp,\n        .ki = gSettings.heater.pid.ki,\n        .kd = gSettings.heater.pid.kd,\n        .max_output = gSettings.heater.pid.max_output,\n        .min_output = gSettings.heater.pid.min_output,\n        .max_integral = gSettings.heater.pid.max_integral,\n        .min_integral = gSettings.heater.pid.min_integral,\n        .cal_type = PID_CAL_TYPE_POSITIONAL\n    };\n    heater.updatePID(params);\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"modifying-settings",children:"Modifying Settings"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"void set_temperature(uint16_t temp) {\n    gSettings.heater.default_temperature = temp;\n    save_global_settings();  // Persist to flash\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"adding-new-settings",children:"Adding New Settings"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Add to structure"})," in ",(0,i.jsx)(t.code,{children:"include/core/settings.h"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"typedef struct {\n    // ... existing ...\n    uint8_t new_setting;\n} heater_settings_t;\n"})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Update default_settings"})," in ",(0,i.jsx)(t.code,{children:"src/core/settings.cpp"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"const settings_t default_settings = {\n    .heater = {\n        // ... existing ...\n        .new_setting = 42,\n    },\n};\n"})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Update serialization"})," in ",(0,i.jsx)(t.code,{children:"src/core/settings.cpp"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:'// In save function\nheater["new_setting"] = settings->heater.new_setting;\n\n// In load function\nsettings->heater.new_setting = heater["new_setting"] | default_settings.heater.new_setting;\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Scenario"}),(0,i.jsx)(t.th,{children:"Behavior"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"File not found"}),(0,i.jsxs)(t.td,{children:["Use ",(0,i.jsx)(t.code,{children:"default_settings"}),", log warning"]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"JSON parse error"}),(0,i.jsxs)(t.td,{children:["Use ",(0,i.jsx)(t.code,{children:"default_settings"}),", log error"]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Write failure"}),(0,i.jsx)(t.td,{children:"Return false, log error"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Version mismatch"}),(0,i.jsx)(t.td,{children:"May trigger migration in future"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"source-files",children:"Source Files"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Header: ",(0,i.jsx)(t.code,{children:"include/settings.h"}),", ",(0,i.jsx)(t.code,{children:"include/core/settings.h"})]}),"\n",(0,i.jsxs)(t.li,{children:["Implementation: ",(0,i.jsx)(t.code,{children:"src/core/settings.cpp"})]}),"\n",(0,i.jsxs)(t.li,{children:["Default data: ",(0,i.jsx)(t.code,{children:"data/settings.json"})]}),"\n",(0,i.jsxs)(t.li,{children:["Schema: ",(0,i.jsx)(t.code,{children:"scripts/settings.schema.json"})]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}}}]);