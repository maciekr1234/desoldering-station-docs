"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[2258],{3522:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"controllers/heater","title":"Heater Controller","description":"High-level temperature control for the desoldering iron heating element.","source":"@site/docs/controllers/heater.md","sourceDirName":"controllers","slug":"/controllers/heater","permalink":"/desoldering-station-docs/docs/controllers/heater","draft":false,"unlisted":false,"editUrl":"https://github.com/maciekr1234/desoldering-station/tree/master/docs-site/docs/controllers/heater.md","tags":[],"version":"current","lastUpdatedAt":1764776824000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Controllers","permalink":"/desoldering-station-docs/docs/category/controllers"},"next":{"title":"Pump Controller","permalink":"/desoldering-station-docs/docs/controllers/pump"}}');var a=t(4848),i=t(8453);const o={sidebar_position:1},s="Heater Controller",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"State Machine",id:"state-machine",level:2},{value:"Error Detection",id:"error-detection",level:2},{value:"HeaterError Enum",id:"heatererror-enum",level:3},{value:"Fault Conditions",id:"fault-conditions",level:3},{value:"API Reference",id:"api-reference",level:2},{value:"Class Definition",id:"class-definition",level:3},{value:"HeaterState Enum",id:"heaterstate-enum",level:3},{value:"Automatic State Transitions",id:"automatic-state-transitions",level:2},{value:"setTargetTemperature() Behavior",id:"settargettemperature-behavior",level:3},{value:"Standby State Behavior",id:"standby-state-behavior",level:3},{value:"Control Loop",id:"control-loop",level:2},{value:"Example Usage",id:"example-usage",level:2},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"Manual State Control (Calibration/Tuning)",id:"manual-state-control-calibrationtuning",level:3},{value:"Safety Features",id:"safety-features",level:2},{value:"Safe Mode",id:"safe-mode",level:3},{value:"Startup Grace Period",id:"startup-grace-period",level:3},{value:"Standby Behavior",id:"standby-behavior",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Source Files",id:"source-files",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"heater-controller",children:"Heater Controller"})}),"\n",(0,a.jsx)(n.p,{children:"High-level temperature control for the desoldering iron heating element."}),"\n",(0,a.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,a.jsx)(n.p,{children:"The HeaterController manages the entire heating subsystem, including PID temperature control, state machine management, error detection, and integration with the pump and UI systems."}),"\n",(0,a.jsx)(n.h2,{id:"features",children:"Features"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"PID-based temperature control"}),"\n",(0,a.jsx)(n.li,{children:"Multi-state operation (Off, Running, Standby, Sleep, Error, Tuning)"}),"\n",(0,a.jsx)(n.li,{children:"Automatic state transitions based on target temperature"}),"\n",(0,a.jsx)(n.li,{children:"Automatic standby temperature from settings"}),"\n",(0,a.jsx)(n.li,{children:"Comprehensive error detection (no handle, sensor failure, overtemperature, runaway heating, heating timeout)"}),"\n",(0,a.jsx)(n.li,{children:"Motion-based wake detection"}),"\n",(0,a.jsx)(n.li,{children:"Safety fault detection with automatic shutdown"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"state-machine",children:"State Machine"}),"\n",(0,a.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e Off: Power On\n    \n    Off --\x3e Running: setTargetTemperature(\u2265min)\n    Running --\x3e Off: setTargetTemperature(<min)\n    \n    Running --\x3e Standby: Standby timeout\n    Standby --\x3e Running: setTargetTemperature()\n    \n    Standby --\x3e Sleep: Extended idle\n    Sleep --\x3e Standby: Motion detected\n    Sleep --\x3e Off: Sleep timeout\n    \n    Off --\x3e Tuning: changeState(Tuning)\n    Tuning --\x3e Off: changeState(Off)\n    \n    Running --\x3e Error: Fault detected\n    Standby --\x3e Error: Fault detected\n    Off --\x3e Error: Runaway detected\n    Error --\x3e Off: clearError()\n    \n    state Running {\n        [*] --\x3e Heating\n        Heating --\x3e AtTemp: Target reached (\xb12\xb0C)\n        AtTemp --\x3e Heating: Temp drops\n    }\n    \n    state Standby {\n        [*] --\x3e StandbyPID\n        StandbyPID: PID at standby_temperature\n    }\n    \n    state Error {\n        [*] --\x3e SafeMode\n        SafeMode: PWM disabled\n        SafeMode: Fault logged\n    }"}),"\n",(0,a.jsx)(n.h2,{id:"error-detection",children:"Error Detection"}),"\n",(0,a.jsx)(n.p,{children:"The heater implements comprehensive error detection:"}),"\n",(0,a.jsx)(n.h3,{id:"heatererror-enum",children:"HeaterError Enum"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:"enum class HeaterError {\n    None = 0,           // No error\n    NoHandle,           // Handle not connected (open circuit)\n    SensorFailure,      // Temperature sensor reading invalid\n    Overtemperature,    // Temperature exceeded maximum safe limit\n    HeatingTimeout,     // Failed to reach target temperature in time\n    RunawayHeating,     // Temperature rising uncontrollably when off\n    UnderTemperature,   // Temperature dropped unexpectedly while heating\n};\n"})}),"\n",(0,a.jsx)(n.h3,{id:"fault-conditions",children:"Fault Conditions"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Fault"}),(0,a.jsx)(n.th,{children:"Condition"}),(0,a.jsx)(n.th,{children:"Threshold"}),(0,a.jsx)(n.th,{children:"Action"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"No Handle"}),(0,a.jsx)(n.td,{children:"Temp reading very low"}),(0,a.jsx)(n.td,{children:"< -900\xb0C"}),(0,a.jsx)(n.td,{children:"Enter Error state"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Sensor Failure"}),(0,a.jsx)(n.td,{children:"Reading out of range"}),(0,a.jsx)(n.td,{children:"< -50\xb0C or > 600\xb0C"}),(0,a.jsx)(n.td,{children:"Enter Error state"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Overtemperature"}),(0,a.jsx)(n.td,{children:"Excessive heat"}),(0,a.jsx)(n.td,{children:"> 480\xb0C"}),(0,a.jsx)(n.td,{children:"Enter Error state"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Heating Timeout"}),(0,a.jsx)(n.td,{children:"Target not reached"}),(0,a.jsx)(n.td,{children:"5 minutes"}),(0,a.jsx)(n.td,{children:"Enter Error state"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Runaway Heating"}),(0,a.jsx)(n.td,{children:"Temp rising when off"}),(0,a.jsx)(n.td,{children:"> 50\xb0C/s"}),(0,a.jsx)(n.td,{children:"Enter Error state"})]})]})]}),"\n",(0,a.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,a.jsx)(n.h3,{id:"class-definition",children:"Class Definition"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:"class HeaterController {\npublic:\n    HeaterController();\n    HeaterController(pin_size_t heater_pin, uint32_t freq_hz = 20);\n    ~HeaterController();\n    \n    // Initialization\n    bool begin(pin_size_t heater_pin, uint32_t freq_hz = 20);\n    bool begin();\n    \n    // State control\n    void changeState(HeaterState new_state);\n    HeaterState getState() const;\n    \n    // Error handling\n    HeaterError getError() const;\n    void clearError();\n    bool isHandleConnected() const;\n    \n    // Temperature control (auto-transitions to Running if valid)\n    void setTargetTemperature(uint16_t celsius);\n    uint16_t getTargetTemperature() const;\n    bool isTargetTemperatureReached() const;\n    uint32_t getTargetTemperatureReachedTime() const;\n    \n    // PID configuration\n    void setPID(float kp, float ki, float kd);\n    void setPID(float kp, float ki, float kd, float imax, float imin);\n    void setPID(const pid_ctrl_parameter_t& params);\n    void setPIDLimits(float imax, float imin);\n    \n    // Pump integration\n    void attachPump(PumpController& pump);\n    PumpController* getPump() const;\n    \n    // Status\n    uint8_t getPowerPercent() const;\n};\n"})}),"\n",(0,a.jsx)(n.h3,{id:"heaterstate-enum",children:"HeaterState Enum"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:"enum class HeaterState {\n    Off,      // Heater disabled, PWM = 0\n    Standby,  // PID control at standby_temperature from settings\n    Sleep,    // Heater off, waiting for motion\n    Running,  // Active PID control at user target\n    Error,    // Fault detected, safe mode\n    Tuning,   // Manual control for PID tuning/calibration\n};\n"})}),"\n",(0,a.jsx)(n.h2,{id:"automatic-state-transitions",children:"Automatic State Transitions"}),"\n",(0,a.jsx)(n.h3,{id:"settargettemperature-behavior",children:"setTargetTemperature() Behavior"}),"\n",(0,a.jsxs)(n.p,{children:["When ",(0,a.jsx)(n.code,{children:"setTargetTemperature()"})," is called:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["If target \u2265 ",(0,a.jsx)(n.code,{children:"CONFIG_MIN_SET_TEMP"})," and not in Error/Tuning \u2192 transitions to ",(0,a.jsx)(n.strong,{children:"Running"})]}),"\n",(0,a.jsxs)(n.li,{children:["If target < ",(0,a.jsx)(n.code,{children:"CONFIG_MIN_SET_TEMP"})," and in Running \u2192 transitions to ",(0,a.jsx)(n.strong,{children:"Off"})]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:"// This automatically starts heating\nheater.setTargetTemperature(350);  // \u2192 Running state\n\n// This automatically stops heating\nheater.setTargetTemperature(0);    // \u2192 Off state\n"})}),"\n",(0,a.jsx)(n.h3,{id:"standby-state-behavior",children:"Standby State Behavior"}),"\n",(0,a.jsx)(n.p,{children:"When entering Standby state:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Automatically sets target to ",(0,a.jsx)(n.code,{children:"gSettings.heater.standby_temperature"})]}),"\n",(0,a.jsx)(n.li,{children:"Maintains temperature using PID control"}),"\n",(0,a.jsxs)(n.li,{children:["Transitions back to Running when ",(0,a.jsx)(n.code,{children:"setTargetTemperature()"})," is called"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"control-loop",children:"Control Loop"}),"\n",(0,a.jsx)(n.p,{children:"The heater runs a dedicated FreeRTOS task at high priority:"}),"\n",(0,a.jsx)(n.mermaid,{value:"graph TB\n    Start[Task Start] --\x3e Read[Read Temperature]\n    Read --\x3e Errors{Error Checks}\n    \n    Errors --\x3e|No Handle| Error[Error State]\n    Errors --\x3e|Sensor Fail| Error\n    Errors --\x3e|Overtemp| Error\n    Errors --\x3e|Runaway| Error\n    Errors --\x3e|OK| Check{State?}\n    \n    Check --\x3e|Running| PID[Compute PID]\n    Check --\x3e|Standby| StandbyPID[PID at standby temp]\n    Check --\x3e|Off/Sleep| Zero[PWM = 0]\n    Check --\x3e|Error| Safe[Safe Mode]\n    Check --\x3e|Tuning| Manual[Manual Control]\n    \n    PID --\x3e SetPWM[Set Heater PWM]\n    StandbyPID --\x3e SetPWM\n    Zero --\x3e SetPWM\n    Safe --\x3e SetPWM\n    Manual --\x3e SetPWM\n    \n    SetPWM --\x3e Pump[Update Pump]\n    Pump --\x3e Delay[Delay 100ms]\n    Delay --\x3e Read"}),"\n",(0,a.jsx)(n.h2,{id:"example-usage",children:"Example Usage"}),"\n",(0,a.jsx)(n.h3,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:'#include "heater.h"\n#include "pump.h"\n\nHeaterController heater(CONFIG_HEATER_PWM_PIN);\nPumpController pump(/* config */);\n\nvoid setup() {\n    // Link heater and pump\n    heater.attachPump(pump);\n    \n    // Configure PID\n    heater.setPID(1.0f, 0.8f, 3.5f, 5.0f, 0.0f);\n    \n    // Initialize\n    if (!heater.begin()) {\n        PICO_LOGE("MAIN", "Heater init failed");\n        return;\n    }\n    \n    // Set target - automatically starts heating\n    heater.setTargetTemperature(350);\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:'void checkHeaterStatus() {\n    if (heater.getState() == HeaterState::Error) {\n        HeaterError err = heater.getError();\n        \n        switch (err) {\n            case HeaterError::NoHandle:\n                PICO_LOGE("UI", "Handle not connected!");\n                break;\n            case HeaterError::Overtemperature:\n                PICO_LOGE("UI", "Overtemperature detected!");\n                break;\n            case HeaterError::HeatingTimeout:\n                PICO_LOGW("UI", "Heating timeout - check element");\n                break;\n            // ... handle other errors\n        }\n        \n        // Clear error and return to Off state\n        heater.clearError();\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"manual-state-control-calibrationtuning",children:"Manual State Control (Calibration/Tuning)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:"// Enter tuning mode for manual power control\nheater.changeState(HeaterState::Tuning);\nheater.setTargetTemperature(350);\n\n// In tuning mode, setPowerPercent() can be used directly\n// for calibration purposes\n\n// Return to normal operation\nheater.changeState(HeaterState::Off);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"safety-features",children:"Safety Features"}),"\n",(0,a.jsx)(n.h3,{id:"safe-mode",children:"Safe Mode"}),"\n",(0,a.jsx)(n.p,{children:"When entering Error state:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"PWM immediately set to 0"}),"\n",(0,a.jsx)(n.li,{children:"PID controller reset"}),"\n",(0,a.jsx)(n.li,{children:"Error code stored"}),"\n",(0,a.jsx)(n.li,{children:"Error logged via PICO_LOGE"}),"\n",(0,a.jsxs)(n.li,{children:["Manual ",(0,a.jsx)(n.code,{children:"clearError()"})," required to recover"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"startup-grace-period",children:"Startup Grace Period"}),"\n",(0,a.jsx)(n.p,{children:"To prevent false runaway detection during boot:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Runaway detection is disabled for first 3 seconds after boot"}),"\n",(0,a.jsx)(n.li,{children:"Allows ADC readings to stabilize"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"standby-behavior",children:"Standby Behavior"}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant User\n    participant Encoder\n    participant Heater\n    participant Settings\n    \n    Note over Heater: Running @ 350\xb0C\n    \n    User->>Encoder: Set down iron\n    Note over Heater: Start standby timer\n    \n    Note over Heater: 10min no activity\n    Heater->>Settings: Get standby_temperature\n    Settings--\x3e>Heater: 180\xb0C\n    Heater->>Heater: Enter Standby @ 180\xb0C\n    \n    User->>Encoder: Rotate to change temp\n    Encoder->>Heater: setTargetTemperature(350)\n    Heater->>Heater: Enter Running @ 350\xb0C"}),"\n",(0,a.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,a.jsxs)(n.p,{children:["Key configuration values in ",(0,a.jsx)(n.code,{children:"config.h"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cpp",children:"#define CONFIG_HEATER_PWM_FREQUENCY_HZ      20      // PWM frequency (Hz)\n#define CONFIG_HEATER_HEATING_TIMEOUT_MS    300000  // 5 minutes\n#define CONFIG_HEATER_STANDBY_TIMEOUT_MS    600000  // 10 minutes\n#define CONFIG_HEATER_OVERTEMP_THRESHOLD    480     // \xb0C\n#define CONFIG_HEATER_RUNAWAY_RATE          50      // \xb0C/s\n#define CONFIG_HEATER_NO_HANDLE_TEMP        (-1000) // ADC value when disconnected\n#define CONFIG_HEATER_SENSOR_MIN_TEMP       (-50)   // \xb0C\n#define CONFIG_HEATER_SENSOR_MAX_TEMP       600     // \xb0C\n"})}),"\n",(0,a.jsx)(n.h2,{id:"source-files",children:"Source Files"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Header: ",(0,a.jsx)(n.code,{children:"include/heater.h"})]}),"\n",(0,a.jsxs)(n.li,{children:["Implementation: ",(0,a.jsx)(n.code,{children:"src/heater.cpp"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var r=t(6540);const a={},i=r.createContext(a);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);