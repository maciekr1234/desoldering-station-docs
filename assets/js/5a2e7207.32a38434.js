"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[2258],{28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var r=t(96540);const s={},a=r.createContext(s);function i(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:n},e.children)}},53522:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"controllers/heater","title":"Heater Controller","description":"High-level temperature control for the desoldering iron heating element.","source":"@site/docs/controllers/heater.md","sourceDirName":"controllers","slug":"/controllers/heater","permalink":"/desoldering-station-docs/docs/controllers/heater","draft":false,"unlisted":false,"editUrl":"https://github.com/maciekr1234/desoldering-station/tree/master/docs-site/docs/controllers/heater.md","tags":[],"version":"current","lastUpdatedAt":1766797362000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Controllers","permalink":"/desoldering-station-docs/docs/category/controllers"},"next":{"title":"Pump Controller","permalink":"/desoldering-station-docs/docs/controllers/pump"}}');var s=t(74848),a=t(28453);const i={sidebar_position:1},l="Heater Controller",d={},c=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"State Machine",id:"state-machine",level:2},{value:"Error Detection",id:"error-detection",level:2},{value:"HeaterError Enum",id:"heatererror-enum",level:3},{value:"Fault Conditions",id:"fault-conditions",level:3},{value:"Tuning Mode Error Handling",id:"tuning-mode-error-handling",level:3},{value:"Heating Timeout Behavior",id:"heating-timeout-behavior",level:3},{value:"API Reference",id:"api-reference",level:2},{value:"Class Definition",id:"class-definition",level:3},{value:"Callback Types",id:"callback-types",level:3},{value:"HeaterState Enum",id:"heaterstate-enum",level:3},{value:"Automatic State Transitions",id:"automatic-state-transitions",level:2},{value:"setTargetTemperature() Behavior",id:"settargettemperature-behavior",level:3},{value:"triggerActivity() Behavior",id:"triggeractivity-behavior",level:3},{value:"Standby State Behavior",id:"standby-state-behavior",level:3},{value:"Control Loop",id:"control-loop",level:2},{value:"Soft Landing",id:"soft-landing",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Menu Access",id:"menu-access",level:3},{value:"Example Usage",id:"example-usage",level:2},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"Using Callbacks",id:"using-callbacks",level:3},{value:"Manual State Control (Calibration/Tuning)",id:"manual-state-control-calibrationtuning",level:3},{value:"Safety Features",id:"safety-features",level:2},{value:"Safe Mode",id:"safe-mode",level:3},{value:"Startup Grace Period",id:"startup-grace-period",level:3},{value:"Standby Behavior",id:"standby-behavior",level:2},{value:"Configuration",id:"configuration-1",level:2},{value:"Source Files",id:"source-files",level:2}];function o(e){const n={a:"a",admonition:"admonition",annotation:"annotation",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",math:"math",mermaid:"mermaid",mfrac:"mfrac",mi:"mi",mn:"mn",mo:"mo",mrow:"mrow",msub:"msub",ol:"ol",p:"p",pre:"pre",semantics:"semantics",span:"span",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"heater-controller",children:"Heater Controller"})}),"\n",(0,s.jsx)(n.p,{children:"High-level temperature control for the desoldering iron heating element."}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The HeaterController manages the entire heating subsystem, including PID temperature control, state machine management, error detection, and integration with the pump and UI systems."}),"\n",(0,s.jsx)(n.h2,{id:"features",children:"Features"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"PID-based temperature control"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Soft Landing"})," \u2014 reduces overshoot by limiting power near setpoint"]}),"\n",(0,s.jsx)(n.li,{children:"Multi-state operation (Sleep, Running, Standby, Error, Tuning)"}),"\n",(0,s.jsx)(n.li,{children:"Automatic state transitions based on target temperature"}),"\n",(0,s.jsx)(n.li,{children:"Automatic standby temperature from settings"}),"\n",(0,s.jsx)(n.li,{children:"Configurable timeouts (heating, standby, sleep) via settings"}),"\n",(0,s.jsxs)(n.li,{children:["Activity-based timer reset via ",(0,s.jsx)(n.code,{children:"triggerActivity()"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Event callbacks"})," \u2014 register handlers for state changes, setpoint changes, temperature reached, and errors"]}),"\n",(0,s.jsx)(n.li,{children:"Comprehensive error detection (no handle, sensor failure, overtemperature, runaway heating, heating timeout)"}),"\n",(0,s.jsx)(n.li,{children:"Motion-based wake detection"}),"\n",(0,s.jsx)(n.li,{children:"Safety fault detection with automatic shutdown"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"state-machine",children:"State Machine"}),"\n",(0,s.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e Sleep: Power On\n    \n    Sleep --\x3e Running: setTargetTemperature(\u2265min)\n    Sleep --\x3e Running: triggerActivity()\n    Running --\x3e Sleep: setTargetTemperature(<min)\n    \n    Running --\x3e Standby: Standby timeout (inactivity)\n    Standby --\x3e Running: setTargetTemperature()\n    Standby --\x3e Running: triggerActivity()\n    \n    Standby --\x3e Sleep: Sleep timeout (inactivity)\n    Sleep --\x3e Standby: Motion detected\n    \n    Sleep --\x3e Tuning: changeState(Tuning)\n    Tuning --\x3e Sleep: changeState(Sleep)\n    \n    Running --\x3e Error: Fault detected\n    Standby --\x3e Error: Fault detected\n    Sleep --\x3e Error: Runaway detected\n    Error --\x3e Sleep: clearError()\n    \n    state Running {\n        [*] --\x3e Heating\n        Heating --\x3e AtTemp: Target reached (\xb12\xb0C)\n        AtTemp --\x3e Heating: Temp drops\n    }\n    \n    state Standby {\n        [*] --\x3e StandbyPID\n        StandbyPID: PID at standby_temperature\n    }\n    \n    state Error {\n        [*] --\x3e SafeMode\n        SafeMode: PWM disabled\n        SafeMode: Fault logged\n    }"}),"\n",(0,s.jsx)(n.h2,{id:"error-detection",children:"Error Detection"}),"\n",(0,s.jsx)(n.p,{children:"The heater implements comprehensive error detection:"}),"\n",(0,s.jsx)(n.h3,{id:"heatererror-enum",children:"HeaterError Enum"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"enum class HeaterError {\n    None = 0,           // No error\n    NoHandle,           // Handle not connected (open circuit)\n    SensorFailure,      // Temperature sensor reading invalid\n    Overtemperature,    // Temperature exceeded maximum safe limit\n    HeatingTimeout,     // Failed to reach target temperature in time\n    RunawayHeating,     // Temperature rising uncontrollably when off\n    UnderTemperature,   // Temperature dropped unexpectedly while heating\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"fault-conditions",children:"Fault Conditions"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Fault"}),(0,s.jsx)(n.th,{children:"Condition"}),(0,s.jsx)(n.th,{children:"Threshold"}),(0,s.jsx)(n.th,{children:"Action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"No Handle"}),(0,s.jsx)(n.td,{children:"Temp reading very low"}),(0,s.jsx)(n.td,{children:"< -900\xb0C"}),(0,s.jsx)(n.td,{children:"Enter Error state"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Sensor Failure"}),(0,s.jsx)(n.td,{children:"Reading out of range"}),(0,s.jsx)(n.td,{children:"< -50\xb0C or > 600\xb0C"}),(0,s.jsx)(n.td,{children:"Enter Error state"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Overtemperature"}),(0,s.jsx)(n.td,{children:"Excessive heat"}),(0,s.jsx)(n.td,{children:"> 480\xb0C"}),(0,s.jsx)(n.td,{children:"Enter Error state"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Heating Timeout"}),(0,s.jsx)(n.td,{children:"Target not reached while heating up"}),(0,s.jsx)(n.td,{children:"Configurable (default 5 min)"}),(0,s.jsx)(n.td,{children:"Enter Error state"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Runaway Heating"}),(0,s.jsx)(n.td,{children:"Temp rising when off"}),(0,s.jsx)(n.td,{children:"> 50\xb0C/s"}),(0,s.jsx)(n.td,{children:"Enter Error state"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"tuning-mode-error-handling",children:"Tuning Mode Error Handling"}),"\n",(0,s.jsxs)(n.p,{children:["During ",(0,s.jsx)(n.strong,{children:"Tuning"})," state (used for PID calibration), most error detection is disabled to allow manual control:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Overtemperature"})," \u2014 Always checked (safety critical)"]}),"\n",(0,s.jsxs)(n.li,{children:["\u274c ",(0,s.jsx)(n.strong,{children:"NoHandle"})," \u2014 Skipped during tuning"]}),"\n",(0,s.jsxs)(n.li,{children:["\u274c ",(0,s.jsx)(n.strong,{children:"SensorFailure"})," \u2014 Skipped during tuning"]}),"\n",(0,s.jsxs)(n.li,{children:["\u274c ",(0,s.jsx)(n.strong,{children:"HeatingTimeout"})," \u2014 Skipped during tuning"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"heating-timeout-behavior",children:"Heating Timeout Behavior"}),"\n",(0,s.jsxs)(n.p,{children:["The heating timeout only triggers when the heater is ",(0,s.jsx)(n.strong,{children:"actively heating up"})," (target temperature > current temperature). This prevents false timeout errors during:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Cooling down (target < current)"}),"\n",(0,s.jsx)(n.li,{children:"Temperature maintenance (target \u2248 current)"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The timer also resets when ",(0,s.jsx)(n.code,{children:"setTargetTemperature()"})," is called with a new value"]}),"\n",(0,s.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,s.jsx)(n.h3,{id:"class-definition",children:"Class Definition"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"class HeaterController {\npublic:\n    HeaterController();\n    HeaterController(pin_size_t heater_pin, uint32_t freq_hz = 20);\n    ~HeaterController();\n    \n    // Initialization\n    bool begin(pin_size_t heater_pin, uint32_t freq_hz = 20);\n    bool begin();\n    \n    // State control\n    void changeState(HeaterState new_state);\n    HeaterState getState() const;\n    \n    // Error handling\n    HeaterError getError() const;\n    void clearError();\n    bool isHandleConnected() const;\n    \n    // Activity trigger (resets standby/sleep timers, wakes from sleep)\n    void triggerActivity();\n    \n    // Temperature control (auto-transitions to Running if valid)\n    void setTargetTemperature(uint16_t celsius);\n    uint16_t getTargetTemperature() const;\n    bool isTargetTemperatureReached() const;\n    uint32_t getTargetTemperatureReachedTime() const;\n    \n    // PID configuration\n    void setPID(float kp, float ki, float kd);\n    void setPID(float kp, float ki, float kd, float imax, float imin);\n    void setPID(const pid_ctrl_parameter_t& params);\n    void setPIDLimits(float imax, float imin);\n    \n    // Pump integration\n    void attachPump(PumpController& pump);\n    PumpController* getPump() const;\n    \n    // Callback registration\n    heater_cb_handle_t onStateChanged(heater_state_cb_t cb, void* user_data = nullptr);\n    heater_cb_handle_t onSetpointChanged(heater_setpoint_cb_t cb, void* user_data = nullptr);\n    heater_cb_handle_t onSetpointReached(heater_reached_cb_t cb, void* user_data = nullptr);\n    heater_cb_handle_t onError(heater_error_cb_t cb, void* user_data = nullptr);\n    void removeCallback(heater_cb_handle_t handle);\n    \n    // Status\n    uint8_t getPowerPercent() const;\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"callback-types",children:"Callback Types"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Callback function pointer types\ntypedef void (*heater_state_cb_t)(HeaterState old_state, HeaterState new_state, void* user_data);\ntypedef void (*heater_setpoint_cb_t)(uint16_t old_setpoint, uint16_t new_setpoint, void* user_data);\ntypedef void (*heater_reached_cb_t)(uint16_t temperature, void* user_data);\ntypedef void (*heater_error_cb_t)(HeaterError error, void* user_data);\n\n// Opaque handle for callback removal\ntypedef struct heater_cb_node* heater_cb_handle_t;\n"})}),"\n",(0,s.jsx)(n.h3,{id:"heaterstate-enum",children:"HeaterState Enum"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"enum class HeaterState {\n    Sleep,    // Heater disabled, PWM = 0\n    Standby,  // PID control at standby_temperature from settings\n    Running,  // Active PID control at user target\n    Error,    // Fault detected, safe mode\n    Tuning,   // Manual control for PID tuning/calibration\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"automatic-state-transitions",children:"Automatic State Transitions"}),"\n",(0,s.jsx)(n.h3,{id:"settargettemperature-behavior",children:"setTargetTemperature() Behavior"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.code,{children:"setTargetTemperature()"})," is called:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If target \u2265 ",(0,s.jsx)(n.code,{children:"CONFIG_MIN_SET_TEMP"})," and not in Error/Tuning \u2192 transitions to ",(0,s.jsx)(n.strong,{children:"Running"})]}),"\n",(0,s.jsxs)(n.li,{children:["If target < ",(0,s.jsx)(n.code,{children:"CONFIG_MIN_SET_TEMP"})," and in Running \u2192 transitions to ",(0,s.jsx)(n.strong,{children:"Sleep"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// This automatically starts heating\nheater.setTargetTemperature(350);  // \u2192 Running state\n\n// This automatically stops heating\nheater.setTargetTemperature(0);    // \u2192 Sleep state\n"})}),"\n",(0,s.jsx)(n.h3,{id:"triggeractivity-behavior",children:"triggerActivity() Behavior"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.code,{children:"triggerActivity()"})," is called:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Resets the inactivity timer used for standby/sleep transitions"}),"\n",(0,s.jsxs)(n.li,{children:["If in Sleep or Standby state with valid target temperature \u2192 transitions to ",(0,s.jsx)(n.strong,{children:"Running"})]}),"\n",(0,s.jsx)(n.li,{children:"Called automatically by pump trigger, encoder rotation, and other user interactions"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Wake from sleep/standby and reset timers\nheater.triggerActivity();\n"})}),"\n",(0,s.jsx)(n.h3,{id:"standby-state-behavior",children:"Standby State Behavior"}),"\n",(0,s.jsx)(n.p,{children:"When entering Standby state:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Automatically sets target to ",(0,s.jsx)(n.code,{children:"gSettings.heater.standby_temperature"})]}),"\n",(0,s.jsx)(n.li,{children:"Maintains temperature using PID control"}),"\n",(0,s.jsxs)(n.li,{children:["Transitions back to Running when ",(0,s.jsx)(n.code,{children:"setTargetTemperature()"})," is called"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"control-loop",children:"Control Loop"}),"\n",(0,s.jsx)(n.p,{children:"The heater runs a dedicated FreeRTOS task at high priority:"}),"\n",(0,s.jsx)(n.mermaid,{value:"graph TB\n    Start[Task Start] --\x3e Read[Read Temperature]\n    Read --\x3e Errors{Error Checks}\n    \n    Errors --\x3e|No Handle| Error[Error State]\n    Errors --\x3e|Sensor Fail| Error\n    Errors --\x3e|Overtemp| Error\n    Errors --\x3e|Runaway| Error\n    Errors --\x3e|OK| Check{State?}\n    \n    Check --\x3e|Running| PID[Compute PID]\n    Check --\x3e|Standby| StandbyPID[PID at standby temp]\n    Check --\x3e|Off/Sleep| Zero[PWM = 0]\n    Check --\x3e|Error| Safe[Safe Mode]\n    Check --\x3e|Tuning| Manual[Manual Control]\n    \n    PID --\x3e SoftLand{Soft Landing?}\n    StandbyPID --\x3e SoftLand\n    \n    SoftLand --\x3e|Enabled & Near Target| Limit[Limit Max Power]\n    SoftLand --\x3e|Disabled or Far| NoLimit[Full Power Allowed]\n    \n    Limit --\x3e SetPWM[Set Heater PWM]\n    NoLimit --\x3e SetPWM\n    Zero --\x3e SetPWM\n    Safe --\x3e SetPWM\n    Manual --\x3e SetPWM\n    \n    SetPWM --\x3e Pump[Update Pump]\n    Pump --\x3e Delay[Delay 100ms]\n    Delay --\x3e Read"}),"\n",(0,s.jsx)(n.h2,{id:"soft-landing",children:"Soft Landing"}),"\n",(0,s.jsx)(n.p,{children:"Soft Landing is a power-limiting feature that reduces maximum heater output as the temperature approaches the setpoint. This significantly reduces overshoot and provides smoother temperature control."}),"\n",(0,s.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,s.jsx)(n.p,{children:"When enabled, the controller limits the maximum power output based on distance from the setpoint:"}),"\n",(0,s.jsx)(n.span,{className:"katex-display",children:(0,s.jsxs)(n.span,{className:"katex",children:[(0,s.jsx)(n.span,{className:"katex-mathml",children:(0,s.jsx)(n.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,s.jsxs)(n.semantics,{children:[(0,s.jsxs)(n.mrow,{children:[(0,s.jsxs)(n.msub,{children:[(0,s.jsx)(n.mi,{children:"P"}),(0,s.jsxs)(n.mrow,{children:[(0,s.jsx)(n.mi,{children:"m"}),(0,s.jsx)(n.mi,{children:"a"}),(0,s.jsx)(n.mi,{children:"x"})]})]}),(0,s.jsx)(n.mo,{children:"="}),(0,s.jsxs)(n.msub,{children:[(0,s.jsx)(n.mi,{children:"P"}),(0,s.jsxs)(n.mrow,{children:[(0,s.jsx)(n.mi,{children:"m"}),(0,s.jsx)(n.mi,{children:"i"}),(0,s.jsx)(n.mi,{children:"n"})]})]}),(0,s.jsx)(n.mo,{children:"+"}),(0,s.jsx)(n.mo,{stretchy:"false",children:"("}),(0,s.jsx)(n.mn,{children:"100"}),(0,s.jsx)(n.mo,{children:"\u2212"}),(0,s.jsxs)(n.msub,{children:[(0,s.jsx)(n.mi,{children:"P"}),(0,s.jsxs)(n.mrow,{children:[(0,s.jsx)(n.mi,{children:"m"}),(0,s.jsx)(n.mi,{children:"i"}),(0,s.jsx)(n.mi,{children:"n"})]})]}),(0,s.jsx)(n.mo,{stretchy:"false",children:")"}),(0,s.jsx)(n.mo,{children:"\xd7"}),(0,s.jsxs)(n.mfrac,{children:[(0,s.jsxs)(n.mrow,{children:[(0,s.jsx)(n.mi,{children:"e"}),(0,s.jsx)(n.mi,{children:"r"}),(0,s.jsx)(n.mi,{children:"r"}),(0,s.jsx)(n.mi,{children:"o"}),(0,s.jsx)(n.mi,{children:"r"})]}),(0,s.jsxs)(n.mrow,{children:[(0,s.jsx)(n.mi,{children:"t"}),(0,s.jsx)(n.mi,{children:"h"}),(0,s.jsx)(n.mi,{children:"r"}),(0,s.jsx)(n.mi,{children:"e"}),(0,s.jsx)(n.mi,{children:"s"}),(0,s.jsx)(n.mi,{children:"h"}),(0,s.jsx)(n.mi,{children:"o"}),(0,s.jsx)(n.mi,{children:"l"}),(0,s.jsx)(n.mi,{children:"d"})]})]})]}),(0,s.jsx)(n.annotation,{encoding:"application/x-tex",children:"P_{max} = P_{min} + (100 - P_{min}) \\times \\frac{error}{threshold}"})]})})}),(0,s.jsxs)(n.span,{className:"katex-html","aria-hidden":"true",children:[(0,s.jsxs)(n.span,{className:"base",children:[(0,s.jsx)(n.span,{className:"strut",style:{height:"0.8333em",verticalAlign:"-0.15em"}}),(0,s.jsxs)(n.span,{className:"mord",children:[(0,s.jsx)(n.span,{className:"mord mathnormal",style:{marginRight:"0.13889em"},children:"P"}),(0,s.jsx)(n.span,{className:"msupsub",children:(0,s.jsxs)(n.span,{className:"vlist-t vlist-t2",children:[(0,s.jsxs)(n.span,{className:"vlist-r",children:[(0,s.jsx)(n.span,{className:"vlist",style:{height:"0.1514em"},children:(0,s.jsxs)(n.span,{style:{top:"-2.55em",marginLeft:"-0.1389em",marginRight:"0.05em"},children:[(0,s.jsx)(n.span,{className:"pstrut",style:{height:"2.7em"}}),(0,s.jsx)(n.span,{className:"sizing reset-size6 size3 mtight",children:(0,s.jsxs)(n.span,{className:"mord mtight",children:[(0,s.jsx)(n.span,{className:"mord mathnormal mtight",children:"ma"}),(0,s.jsx)(n.span,{className:"mord mathnormal mtight",children:"x"})]})})]})}),(0,s.jsx)(n.span,{className:"vlist-s",children:"\u200b"})]}),(0,s.jsx)(n.span,{className:"vlist-r",children:(0,s.jsx)(n.span,{className:"vlist",style:{height:"0.15em"},children:(0,s.jsx)(n.span,{})})})]})})]}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,s.jsx)(n.span,{className:"mrel",children:"="}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,s.jsxs)(n.span,{className:"base",children:[(0,s.jsx)(n.span,{className:"strut",style:{height:"0.8333em",verticalAlign:"-0.15em"}}),(0,s.jsxs)(n.span,{className:"mord",children:[(0,s.jsx)(n.span,{className:"mord mathnormal",style:{marginRight:"0.13889em"},children:"P"}),(0,s.jsx)(n.span,{className:"msupsub",children:(0,s.jsxs)(n.span,{className:"vlist-t vlist-t2",children:[(0,s.jsxs)(n.span,{className:"vlist-r",children:[(0,s.jsx)(n.span,{className:"vlist",style:{height:"0.3117em"},children:(0,s.jsxs)(n.span,{style:{top:"-2.55em",marginLeft:"-0.1389em",marginRight:"0.05em"},children:[(0,s.jsx)(n.span,{className:"pstrut",style:{height:"2.7em"}}),(0,s.jsx)(n.span,{className:"sizing reset-size6 size3 mtight",children:(0,s.jsx)(n.span,{className:"mord mtight",children:(0,s.jsx)(n.span,{className:"mord mathnormal mtight",children:"min"})})})]})}),(0,s.jsx)(n.span,{className:"vlist-s",children:"\u200b"})]}),(0,s.jsx)(n.span,{className:"vlist-r",children:(0,s.jsx)(n.span,{className:"vlist",style:{height:"0.15em"},children:(0,s.jsx)(n.span,{})})})]})})]}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,s.jsx)(n.span,{className:"mbin",children:"+"}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,s.jsxs)(n.span,{className:"base",children:[(0,s.jsx)(n.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,s.jsx)(n.span,{className:"mopen",children:"("}),(0,s.jsx)(n.span,{className:"mord",children:"100"}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,s.jsx)(n.span,{className:"mbin",children:"\u2212"}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,s.jsxs)(n.span,{className:"base",children:[(0,s.jsx)(n.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,s.jsxs)(n.span,{className:"mord",children:[(0,s.jsx)(n.span,{className:"mord mathnormal",style:{marginRight:"0.13889em"},children:"P"}),(0,s.jsx)(n.span,{className:"msupsub",children:(0,s.jsxs)(n.span,{className:"vlist-t vlist-t2",children:[(0,s.jsxs)(n.span,{className:"vlist-r",children:[(0,s.jsx)(n.span,{className:"vlist",style:{height:"0.3117em"},children:(0,s.jsxs)(n.span,{style:{top:"-2.55em",marginLeft:"-0.1389em",marginRight:"0.05em"},children:[(0,s.jsx)(n.span,{className:"pstrut",style:{height:"2.7em"}}),(0,s.jsx)(n.span,{className:"sizing reset-size6 size3 mtight",children:(0,s.jsx)(n.span,{className:"mord mtight",children:(0,s.jsx)(n.span,{className:"mord mathnormal mtight",children:"min"})})})]})}),(0,s.jsx)(n.span,{className:"vlist-s",children:"\u200b"})]}),(0,s.jsx)(n.span,{className:"vlist-r",children:(0,s.jsx)(n.span,{className:"vlist",style:{height:"0.15em"},children:(0,s.jsx)(n.span,{})})})]})})]}),(0,s.jsx)(n.span,{className:"mclose",children:")"}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,s.jsx)(n.span,{className:"mbin",children:"\xd7"}),(0,s.jsx)(n.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,s.jsxs)(n.span,{className:"base",children:[(0,s.jsx)(n.span,{className:"strut",style:{height:"1.7936em",verticalAlign:"-0.686em"}}),(0,s.jsxs)(n.span,{className:"mord",children:[(0,s.jsx)(n.span,{className:"mopen nulldelimiter"}),(0,s.jsx)(n.span,{className:"mfrac",children:(0,s.jsxs)(n.span,{className:"vlist-t vlist-t2",children:[(0,s.jsxs)(n.span,{className:"vlist-r",children:[(0,s.jsxs)(n.span,{className:"vlist",style:{height:"1.1076em"},children:[(0,s.jsxs)(n.span,{style:{top:"-2.314em"},children:[(0,s.jsx)(n.span,{className:"pstrut",style:{height:"3em"}}),(0,s.jsxs)(n.span,{className:"mord",children:[(0,s.jsx)(n.span,{className:"mord mathnormal",children:"t"}),(0,s.jsx)(n.span,{className:"mord mathnormal",children:"h"}),(0,s.jsx)(n.span,{className:"mord mathnormal",children:"res"}),(0,s.jsx)(n.span,{className:"mord mathnormal",children:"h"}),(0,s.jsx)(n.span,{className:"mord mathnormal",children:"o"}),(0,s.jsx)(n.span,{className:"mord mathnormal",style:{marginRight:"0.01968em"},children:"l"}),(0,s.jsx)(n.span,{className:"mord mathnormal",children:"d"})]})]}),(0,s.jsxs)(n.span,{style:{top:"-3.23em"},children:[(0,s.jsx)(n.span,{className:"pstrut",style:{height:"3em"}}),(0,s.jsx)(n.span,{className:"frac-line",style:{borderBottomWidth:"0.04em"}})]}),(0,s.jsxs)(n.span,{style:{top:"-3.677em"},children:[(0,s.jsx)(n.span,{className:"pstrut",style:{height:"3em"}}),(0,s.jsx)(n.span,{className:"mord",children:(0,s.jsx)(n.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"},children:"error"})})]})]}),(0,s.jsx)(n.span,{className:"vlist-s",children:"\u200b"})]}),(0,s.jsx)(n.span,{className:"vlist-r",children:(0,s.jsx)(n.span,{className:"vlist",style:{height:"0.686em"},children:(0,s.jsx)(n.span,{})})})]})}),(0,s.jsx)(n.span,{className:"mclose nulldelimiter"})]})]})]})]})}),"\n",(0,s.jsx)(n.p,{children:"For example, with default settings (threshold=30\xb0C, min_power=40%):"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"At 30\xb0C below setpoint: max power = 100%"}),"\n",(0,s.jsx)(n.li,{children:"At 15\xb0C below setpoint: max power = 70%"}),"\n",(0,s.jsx)(n.li,{children:"At setpoint: max power = 40%"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["Soft landing settings are stored in ",(0,s.jsx)(n.code,{children:"heater_settings_t"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"struct {\n    bool    enabled;       // Enable/disable soft landing\n    uint8_t threshold;     // Distance (\xb0C) where limiting begins\n    uint8_t min_power_pct; // Minimum power cap (%) at setpoint\n} soft_landing;\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Default values:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"enabled"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"true"})}),(0,s.jsx)(n.td,{children:"Enabled by default"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"threshold"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"30\xb0C"})}),(0,s.jsx)(n.td,{children:"Start limiting 30\xb0C from setpoint"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"min_power_pct"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"40%"})}),(0,s.jsx)(n.td,{children:"Cap power at 40% when at setpoint"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"menu-access",children:"Menu Access"}),"\n",(0,s.jsxs)(n.p,{children:["Navigate to ",(0,s.jsx)(n.strong,{children:"Settings"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Heater"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Soft Landing"})," to configure."]}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.a,{href:"/desoldering-station-docs/docs/guides/pid-calibration",children:"Manual PID Tuning Guide"})," for detailed tuning instructions."]}),"\n",(0,s.jsx)(n.h2,{id:"example-usage",children:"Example Usage"}),"\n",(0,s.jsx)(n.h3,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'#include "heater.h"\n#include "pump.h"\n\nHeaterController heater(CONFIG_HEATER_PWM_PIN);\nPumpController pump(/* config */);\n\nvoid setup() {\n    // Link heater and pump\n    heater.attachPump(pump);\n    \n    // Configure PID\n    heater.setPID(1.0f, 0.8f, 3.5f, 5.0f, 0.0f);\n    \n    // Initialize\n    if (!heater.begin()) {\n        PICO_LOGE("MAIN", "Heater init failed");\n        return;\n    }\n    \n    // Set target - automatically starts heating\n    heater.setTargetTemperature(350);\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'void checkHeaterStatus() {\n    if (heater.getState() == HeaterState::Error) {\n        HeaterError err = heater.getError();\n        \n        switch (err) {\n            case HeaterError::NoHandle:\n                PICO_LOGE("UI", "Handle not connected!");\n                break;\n            case HeaterError::Overtemperature:\n                PICO_LOGE("UI", "Overtemperature detected!");\n                break;\n            case HeaterError::HeatingTimeout:\n                PICO_LOGW("UI", "Heating timeout - check element");\n                break;\n            // ... handle other errors\n        }\n        \n        // Clear error and return to Off state\n        heater.clearError();\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"using-callbacks",children:"Using Callbacks"}),"\n",(0,s.jsx)(n.p,{children:"The HeaterController provides a callback system for reacting to events without polling. Multiple callbacks can be registered for each event type, and they are invoked in a thread-safe manner without blocking the heater control loop."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'// Callback function for state changes\nvoid on_state_change(HeaterState old_state, HeaterState new_state, void* ctx) {\n    PICO_LOGI("UI", "Heater state: %d -> %d", (int)old_state, (int)new_state);\n    // Update UI, trigger sounds, etc.\n}\n\n// Callback for when target temperature is reached\nvoid on_temp_reached(uint16_t temp, void* ctx) {\n    PICO_LOGI("UI", "Target temperature %d\xb0C reached!", temp);\n    // Could trigger a beep or notification\n}\n\n// Callback for errors\nvoid on_error(HeaterError error, void* ctx) {\n    PICO_LOGE("UI", "Heater error: %d", (int)error);\n    // Show error dialog, play alarm sound, etc.\n}\n\nvoid setup() {\n    // Register callbacks (returns handle for later removal)\n    heater_cb_handle_t state_handle = gHeater.onStateChanged(on_state_change, nullptr);\n    heater_cb_handle_t reached_handle = gHeater.onSetpointReached(on_temp_reached, nullptr);\n    heater_cb_handle_t error_handle = gHeater.onError(on_error, nullptr);\n    \n    // ... later, to remove a callback:\n    gHeater.removeCallback(state_handle);\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Callback Events:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Event"}),(0,s.jsx)(n.th,{children:"Callback Type"}),(0,s.jsx)(n.th,{children:"Triggered When"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"State Changed"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"heater_state_cb_t"})}),(0,s.jsx)(n.td,{children:"Heater transitions between states"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Setpoint Changed"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"heater_setpoint_cb_t"})}),(0,s.jsx)(n.td,{children:"Target temperature is modified"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Setpoint Reached"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"heater_reached_cb_t"})}),(0,s.jsx)(n.td,{children:"Temperature first reaches target (\xb12\xb0C)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Error"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"heater_error_cb_t"})}),(0,s.jsx)(n.td,{children:"Heater enters Error state"})]})]})]}),"\n",(0,s.jsx)(n.admonition,{title:"Thread Safety",type:"note",children:(0,s.jsx)(n.p,{children:"Callbacks are invoked from the heater control task but are designed to not block the control loop. A snapshot of registered callbacks is taken under mutex protection, then callbacks are invoked outside the mutex. Maximum 8 callbacks per event type are supported."})}),"\n",(0,s.jsx)(n.h3,{id:"manual-state-control-calibrationtuning",children:"Manual State Control (Calibration/Tuning)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Enter tuning mode for manual power control\nheater.changeState(HeaterState::Tuning);\nheater.setTargetTemperature(350);\n\n// In tuning mode, setPowerPercent() can be used directly\n// for calibration purposes\n\n// Return to normal operation\nheater.changeState(HeaterState::Sleep);\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"Auto-Tuning",type:"tip",children:(0,s.jsxs)(n.p,{children:["For automatic PID tuning using the Ziegler\u2013Nichols relay method, see the ",(0,s.jsx)(n.a,{href:"/desoldering-station-docs/docs/guides/auto-tuning",children:"Auto-Tuning Guide"}),"."]})}),"\n",(0,s.jsx)(n.h2,{id:"safety-features",children:"Safety Features"}),"\n",(0,s.jsx)(n.h3,{id:"safe-mode",children:"Safe Mode"}),"\n",(0,s.jsx)(n.p,{children:"When entering Error state:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"PWM immediately set to 0"}),"\n",(0,s.jsx)(n.li,{children:"PID controller reset"}),"\n",(0,s.jsx)(n.li,{children:"Error code stored"}),"\n",(0,s.jsx)(n.li,{children:"Error logged via PICO_LOGE"}),"\n",(0,s.jsxs)(n.li,{children:["Manual ",(0,s.jsx)(n.code,{children:"clearError()"})," required to recover"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"startup-grace-period",children:"Startup Grace Period"}),"\n",(0,s.jsx)(n.p,{children:"To prevent false runaway detection during boot:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Runaway detection is disabled for first 3 seconds after boot"}),"\n",(0,s.jsx)(n.li,{children:"Allows ADC readings to stabilize"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"standby-behavior",children:"Standby Behavior"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant User\n    participant Encoder\n    participant Heater\n    participant Settings\n    \n    Note over Heater: Running @ 350\xb0C\n    \n    User->>Encoder: Set down iron\n    Note over Heater: Start standby timer\n    \n    Note over Heater: 10min no activity\n    Heater->>Settings: Get standby_temperature\n    Settings--\x3e>Heater: 180\xb0C\n    Heater->>Heater: Enter Standby @ 180\xb0C\n    \n    User->>Encoder: Rotate to change temp\n    Encoder->>Heater: setTargetTemperature(350)\n    Heater->>Heater: Enter Running @ 350\xb0C"}),"\n",(0,s.jsx)(n.h2,{id:"configuration-1",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["Key configuration values in ",(0,s.jsx)(n.code,{children:"config.h"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"#define CONFIG_HEATER_PWM_FREQUENCY_HZ      20      // PWM frequency (Hz)\n#define CONFIG_HEATER_HEATING_TIMEOUT_MS    300000  // 5 minutes\n#define CONFIG_HEATER_STANDBY_TIMEOUT_MS    600000  // 10 minutes\n#define CONFIG_HEATER_OVERTEMP_THRESHOLD    480     // \xb0C\n#define CONFIG_HEATER_RUNAWAY_RATE          50      // \xb0C/s\n#define CONFIG_HEATER_NO_HANDLE_TEMP        (-1000) // ADC value when disconnected\n#define CONFIG_HEATER_SENSOR_MIN_TEMP       (-50)   // \xb0C\n#define CONFIG_HEATER_SENSOR_MAX_TEMP       600     // \xb0C\n"})}),"\n",(0,s.jsx)(n.h2,{id:"source-files",children:"Source Files"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Header: ",(0,s.jsx)(n.code,{children:"include/heater.h"})]}),"\n",(0,s.jsxs)(n.li,{children:["Implementation: ",(0,s.jsx)(n.code,{children:"src/heater.cpp"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}}}]);