"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[8773],{14387:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"drivers/motion-sensor","title":"Motion Sensor Driver","description":"Pulse-width based motion detection for activity tracking.","source":"@site/docs/drivers/motion-sensor.md","sourceDirName":"drivers","slug":"/drivers/motion-sensor","permalink":"/desoldering-station-docs/docs/drivers/motion-sensor","draft":false,"unlisted":false,"editUrl":"https://github.com/maciekr1234/desoldering-station/tree/master/docs-site/docs/drivers/motion-sensor.md","tags":[],"version":"current","lastUpdatedAt":1764960705000,"sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"docsSidebar","previous":{"title":"Encoder Driver","permalink":"/desoldering-station-docs/docs/drivers/encoder"},"next":{"title":"Controllers","permalink":"/desoldering-station-docs/docs/category/controllers"}}');var s=i(74848),r=i(28453);const l={sidebar_position:7},o="Motion Sensor Driver",d={},a=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"Pulse Detection",id:"pulse-detection",level:2},{value:"API Reference",id:"api-reference",level:2},{value:"Class Definition",id:"class-definition",level:3},{value:"Pulse Filtering",id:"pulse-filtering",level:2},{value:"Integration with Heater",id:"integration-with-heater",level:2},{value:"Example Usage",id:"example-usage",level:2},{value:"Configuration in Settings",id:"configuration-in-settings",level:2},{value:"Source Files",id:"source-files",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"motion-sensor-driver",children:"Motion Sensor Driver"})}),"\n",(0,s.jsx)(n.p,{children:"Pulse-width based motion detection for activity tracking."}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The Motion Sensor driver detects valid pulses from a shake/motion sensor connected to a GPIO pin. It uses interrupt-driven edge detection to measure pulse width and filters out noise by requiring a minimum pulse duration. Used to detect handle activity for standby/sleep timeout management."}),"\n",(0,s.jsx)(n.h2,{id:"features",children:"Features"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Interrupt-driven pulse detection"}),"\n",(0,s.jsx)(n.li,{children:"Configurable minimum pulse width filter"}),"\n",(0,s.jsx)(n.li,{children:"Callback on valid pulse detection"}),"\n",(0,s.jsx)(n.li,{children:"Time since last valid pulse tracking"}),"\n",(0,s.jsx)(n.li,{children:"Pulse width measurement"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"pulse-detection",children:"Pulse Detection"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant GPIO as GPIO Pin\n    participant ISR as Interrupt Handler\n    participant Filter as Pulse Filter\n    participant CB as Callback\n    \n    GPIO->>ISR: Falling edge\n    Note over ISR: Record timestamp\n    GPIO->>ISR: Rising edge\n    ISR->>Filter: Pulse width\n    alt width >= filter_us\n        Filter->>CB: Valid pulse!\n    else width < filter_us\n        Filter--\x3e>Filter: Ignored (noise)\n    end"}),"\n",(0,s.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,s.jsx)(n.h3,{id:"class-definition",children:"Class Definition"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"class MotionSensor {\npublic:\n    // Constructor\n    // pin: GPIO pin connected to motion sensor\n    // filter_us: Minimum pulse width in microseconds (default: 200ms = 200000us)\n    MotionSensor(pin_size_t pin, uint32_t filter_us = 200000);\n    ~MotionSensor();\n    \n    // Lifecycle\n    void begin();\n    void end();\n    void update();  // Call periodically to process pulses\n    \n    // Callback for valid pulse detection\n    void setCallback(std::function<void()> callback);\n    \n    // Filter configuration\n    void setFilterTime(uint32_t filter_us);\n    uint32_t getFilterTime() const;\n    uint32_t getFilterTimeMs() const;\n    \n    // Pulse information\n    uint32_t getLastPulseWidth() const;      // Last pulse width in microseconds\n    uint32_t getLastPulseWidthMs() const;    // Last pulse width in milliseconds\n    \n    // Timing\n    uint32_t getLastValidPulseTime() const;      // Timestamp of last valid pulse (us)\n    uint32_t getLastValidPulseTimeMs() const;    // Timestamp in milliseconds\n    uint32_t getTimeSinceLastValidPulseMs() const;  // Time since last valid pulse\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"pulse-filtering",children:"Pulse Filtering"}),"\n",(0,s.jsx)(n.p,{children:"The sensor filters out noise by requiring pulses to exceed a minimum duration:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Filter Setting"}),(0,s.jsx)(n.th,{children:"Value"}),(0,s.jsx)(n.th,{children:"Use Case"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"High sensitivity"}),(0,s.jsx)(n.td,{children:"50ms"}),(0,s.jsx)(n.td,{children:"Detect small movements"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Default"}),(0,s.jsx)(n.td,{children:"200ms"}),(0,s.jsx)(n.td,{children:"Normal shake detection"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Low sensitivity"}),(0,s.jsx)(n.td,{children:"500ms"}),(0,s.jsx)(n.td,{children:"Only deliberate shakes"})]})]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Set filter to 100ms (100000 microseconds)\nmotion.setFilterTime(100000);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-heater",children:"Integration with Heater"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant MS as MotionSensor\n    participant HC as HeaterController\n    \n    Note over MS: Handle shaken\n    MS->>HC: callback()\n    HC->>HC: Reset activity timer\n    \n    Note over MS: No activity for standby_timeout\n    HC->>HC: Enter Standby\n    \n    Note over MS: No activity for sleep_timeout\n    HC->>HC: Enter Sleep"}),"\n",(0,s.jsx)(n.h2,{id:"example-usage",children:"Example Usage"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'#include "drivers/motion_sensor.h"\n\n// Motion sensor on GPIO 24, 200ms minimum pulse\nMotionSensor motion(24, 200000);\n\nvoid setup() {\n    motion.begin();\n    \n    // Set callback for valid pulse detection\n    motion.setCallback([]() {\n        PICO_LOGI("MOTION", "Activity detected!");\n        heater.resetActivityTimer();\n    });\n}\n\nvoid motion_task() {\n    while (true) {\n        motion.update();\n        \n        // Check idle time for standby/sleep logic\n        uint32_t idle_ms = motion.getTimeSinceLastValidPulseMs();\n        \n        if (idle_ms > SLEEP_TIMEOUT_MS) {\n            heater.enterSleep();\n        } else if (idle_ms > STANDBY_TIMEOUT_MS) {\n            heater.enterStandby();\n        }\n        \n        vTaskDelay(pdMS_TO_TICKS(100));\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"configuration-in-settings",children:"Configuration in Settings"}),"\n",(0,s.jsxs)(n.p,{children:["The motion sensor settings are stored in ",(0,s.jsx)(n.code,{children:"heater_settings_t.shake_sensor"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"struct {\n    bool     enabled;  // Enable/disable shake sensor\n    bool     invert;   // Invert logic level (active low)\n    uint32_t pulse_ms; // Minimum pulse duration in milliseconds\n} shake_sensor;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"source-files",children:"Source Files"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Header: ",(0,s.jsx)(n.code,{children:"include/drivers/motion_sensor.h"})]}),"\n",(0,s.jsxs)(n.li,{children:["Implementation: ",(0,s.jsx)(n.code,{children:"src/drivers/motion_sensor.cpp"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>o});var t=i(96540);const s={},r=t.createContext(s);function l(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);